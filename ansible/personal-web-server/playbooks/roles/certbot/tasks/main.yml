---
- name: Install required packages
  apt:
    name: 
      - certbot
      - python3-certbot-apache
      - ssl-cert
    state: present
    update_cache: yes

- name: Ensure Apache modules for SSL are enabled
  apache2_module:
    name: "{{ item }}"
    state: present
  with_items:
    - ssl
    - rewrite
    - headers

# First try if Apache can start without SSL
- name: Ensure basic Apache is running
  service:
    name: apache2
    state: started
    enabled: yes
  ignore_errors: yes

# Check if certificates already exist
- name: Check if certificates already exist
  stat:
    path: "/etc/letsencrypt/live/{{ item.server_name }}/fullchain.pem"
  register: cert_exists
  loop: "{{ sites }}"
  ignore_errors: yes

# Stop Apache temporarily if using standalone mode
- name: Stop Apache temporarily if using standalone mode
  service:
    name: apache2
    state: stopped
  when: certbot.standalone | default(false)
  register: apache_stopped_for_cert
  ignore_errors: yes

# Try to obtain certificates
- name: Obtain certificates for domains (standalone method)
  command: >
    certbot certonly --standalone
    {{ '--staging' if certbot.use_staging | default(false) else '' }}
    --non-interactive --agree-tos 
    --email {{ item.item.certbot_email | default('webmaster@' + item.item.server_name) }}
    -d {{ item.item.server_name }}
    --cert-name {{ item.item.server_name }}
  loop: "{{ cert_exists.results }}"
  when: 
    - not item.stat.exists | default(false) 
    - certbot.create_if_missing | default(true)
    - certbot.standalone | default(false)
    - apache_stopped_for_cert is not failed
  register: certbot_standalone_result
  ignore_errors: yes

# Start Apache again after standalone certificate issuance
- name: Start Apache again after standalone certificate issuance
  service:
    name: apache2
    state: started
  when: apache_stopped_for_cert.changed | default(false)
  ignore_errors: yes

# Check if certificates exist after attempting to create them
- name: Recheck if certificates exist after obtaining them
  stat:
    path: "/etc/letsencrypt/live/{{ item.server_name }}/fullchain.pem"
  register: certs_after_creation
  loop: "{{ sites }}"
  ignore_errors: yes

# Configure SSL only for domains where we have certificates
- name: Configure Apache for SSL only for domains with certificates
  include_tasks: configure_apache_ssl.yml
  vars:
    domain_has_cert: "{{ certs_after_creation.results | selectattr('item.server_name', 'equalto', item.server_name) | selectattr('stat.exists', 'defined') | selectattr('stat.exists') | list | length > 0 }}"
  loop: "{{ sites }}"
  when: domain_has_cert
  ignore_errors: yes

# Set up auto-renewal
- name: Set up auto-renewal
  cron:
    name: "Certbot renewal"
    job: "certbot renew --quiet --no-self-upgrade {{ '--pre-hook \"systemctl stop apache2\"' if certbot.standalone | default(false) else '' }} {{ '--post-hook \"' + certbot.renew_hook + '\"' if certbot.renew_hook is defined else '' }}"
    hour: "3"
    minute: "30"
    weekday: "1"  # Monday