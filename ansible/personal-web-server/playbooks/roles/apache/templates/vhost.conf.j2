<VirtualHost *:80>
    ServerName {{ item.server_name }}
    {% if item.server_aliases is defined %}
    ServerAlias {% for alias in item.server_aliases %}{{ alias }} {% endfor %}
    {% endif %}
    
    DocumentRoot {{ item.root }}
    
    <Directory {{ item.root }}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/{{ item.server_name }}_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.server_name }}_access.log combined
</VirtualHost>

{% if item.ssl_certificate is defined %}
<VirtualHost *:443>
    ServerName {{ item.server_name }}
    {% if item.server_aliases is defined %}
    ServerAlias {% for alias in item.server_aliases %}{{ alias }} {% endfor %}
    {% endif %}
    
    DocumentRoot {{ item.root }}
    
    <Directory {{ item.root }}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/{{ item.server_name }}_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.server_name }}_ssl_access.log combined
    
    SSLEngine on
    SSLCertificateFile {{ item.ssl_certificate }}
    SSLCertificateKeyFile {{ item.ssl_certificate_key }}
    
    # Optional: Modern SSL configuration
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder on
    SSLCompression off
</VirtualHost>
{% endif %}