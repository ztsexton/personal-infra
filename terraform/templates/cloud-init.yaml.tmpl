#cloud-config
package_update: true
package_upgrade: true
packages:
  - curl
  - ca-certificates
  - ufw
write_files:
  - path: /root/bootstrap.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      echo "[bootstrap] Starting" | systemd-cat -t bootstrap -p info
      # Firewall
      ufw default deny incoming || true
      ufw default allow outgoing || true
      for p in 22 80 443; do ufw allow $p/tcp || true; done
      echo 'y' | ufw enable || true

      # Install k3s (idempotent guard)
      if ! command -v k3s >/dev/null 2>&1; then
        export K3S_TOKEN="${k3s_token}"
        DISABLE_ARG="${disable_arg}"
        INSTALL_K3S_EXEC="server $DISABLE_ARG --write-kubeconfig-mode=600"
        echo "[bootstrap] Installing k3s (DISABLE_TRAEFIK=${disable_traefik})" | systemd-cat -t bootstrap -p info
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="$INSTALL_K3S_EXEC" sh -
      else
        echo "[bootstrap] k3s already installed; skipping" | systemd-cat -t bootstrap -p info
      fi

      # Ensure kubectl symlink exists
      if ! command -v kubectl >/dev/null 2>&1 && [ -x /usr/local/bin/k3s ]; then
        ln -s /usr/local/bin/k3s /usr/local/bin/kubectl || true
      fi

      # kubeconfig convenience
      mkdir -p /root/.kube
      cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
      chmod 600 /root/.kube/config
      PUBIP=$(curl -s ifconfig.me || curl -s https://api.ipify.org || echo 127.0.0.1)
      sed -i "s/127.0.0.1/$PUBIP/" /root/.kube/config || true

      MANIFEST_DIR=/var/lib/rancher/k3s/server/manifests
      mkdir -p "$MANIFEST_DIR"

      # Argo CD namespace
      cat > "$MANIFEST_DIR/00-argocd-namespace.yaml" <<'NS'
      apiVersion: v1
      kind: Namespace
      metadata:
        name: argocd
        labels:
          app.kubernetes.io/name: argocd
      NS

      # Argo CD HelmChart
      cat > "$MANIFEST_DIR/argocd.helmchart.yaml" <<'HCH'
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: argo-cd
        namespace: kube-system
      spec:
        repo: https://argoproj.github.io/argo-helm
        chart: argo-cd
        targetNamespace: argocd
        version: ${argocd_helm_version}
        valuesContent: |
          server:
            ingress:
              enabled: true
              hosts:
                - ${argocd_domain}
              annotations:
                cert-manager.io/cluster-issuer: cloudflare-dns
              tls: true
          configs:
            params:
              server.insecure: true
            secret:
              argocdServerAdminPassword: ${argocd_admin_password_bcrypt}
      HCH

      # Always write root Application manifest (idempotent)
      cat > "$MANIFEST_DIR/10-argocd-root-application.yaml" <<'ROOTAPP'
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: root
        namespace: argocd
        annotations:
          argocd.argoproj.io/sync-wave: "-2"
      spec:
        project: default
        source:
          repoURL: ${git_repo_url}
          path: ${git_root_app_path}
          targetRevision: ${git_revision}
          directory:
            recurse: true
        destination:
          server: https://kubernetes.default.svc
          namespace: argocd
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          syncOptions:
            - CreateNamespace=true
      ROOTAPP
      echo "[bootstrap] Root Application manifest written (k3s will apply when CRD ready)" | systemd-cat -t bootstrap -p info

      # Fallback Job: retry root Application until successful (safety net for timing issues)
      cat > "$MANIFEST_DIR/11-argocd-root-fallback.yaml" <<'FALLBACK'
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: argocd-root-fallback
        namespace: argocd
      spec:
        backoffLimit: 10
        template:
          spec:
            serviceAccountName: default
            restartPolicy: OnFailure
            containers:
              - name: ensure-root
                image: alpine:3.19
                command:
                  - /bin/sh
                  - -c
                  - |
                    set -e
                    echo "[fallback] Waiting for Application CRD and root Application"
                    for attempt in $(seq 1 30); do
                      if kubectl get crd applications.argoproj.io >/dev/null 2>&1; then
                        if kubectl get app root -n argocd >/dev/null 2>&1; then
                          echo "[fallback] Root Application exists, success"
                          exit 0
                        else
                          echo "[fallback] CRD exists but root app missing, reapplying..."
                          cat <<'INNER_ROOT' | kubectl apply -f -
                    apiVersion: argoproj.io/v1alpha1
                    kind: Application
                    metadata:
                      name: root
                      namespace: argocd
                      annotations:
                        argocd.argoproj.io/sync-wave: "-2"
                    spec:
                      project: default
                      source:
                        repoURL: ${git_repo_url}
                        path: ${git_root_app_path}
                        targetRevision: ${git_revision}
                        directory:
                          recurse: true
                      destination:
                        server: https://kubernetes.default.svc
                        namespace: argocd
                      syncPolicy:
                        automated:
                          prune: true
                          selfHeal: true
                        syncOptions:
                          - CreateNamespace=true
                    INNER_ROOT
                          echo "[fallback] Root Application applied"
                          exit 0
                        fi
                      fi
                      echo "[fallback] Waiting for CRD (attempt $attempt/30)"
                      sleep 10
                    done
                    echo "[fallback] Timeout waiting for CRD or applying root Application"
                    exit 1
      FALLBACK
      echo "[bootstrap] Fallback Job created for root Application reliability" | systemd-cat -t bootstrap -p info

      echo "[bootstrap] Files seeded. Waiting for Argo CD server" | systemd-cat -t bootstrap -p info
      for i in {1..40}; do
        if kubectl get pods -n argocd 2>/dev/null | grep -q 'argocd-server'; then
          echo "[bootstrap] Argo CD detected" | systemd-cat -t bootstrap -p info
          break
        fi
        sleep 15
      done
      echo "[bootstrap] Complete" | systemd-cat -t bootstrap -p info
runcmd:
  - /root/bootstrap.sh
