name: Bootstrap 1Password Secrets

on:
  workflow_dispatch:
    inputs:
      connect_token:
        description: '1Password Connect Token'
        required: true
        type: string
  workflow_call:
    inputs:
      server_ip:
        description: 'Kubernetes server IP'
        required: true
        type: string
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      ONEPASSWORD_CONNECT_TOKEN:
        required: true

jobs:
  bootstrap-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add target host key
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ inputs.server_ip || '5.161.81.57' }} >> ~/.ssh/known_hosts

    - name: Create 1Password bootstrap secret
      run: |
        # Get the connect token from input or secret
        CONNECT_TOKEN="${{ inputs.connect_token || secrets.ONEPASSWORD_CONNECT_TOKEN }}"
        
        if [ -z "$CONNECT_TOKEN" ]; then
          echo "‚ùå No 1Password Connect token provided"
          exit 1
        fi
        
        # Connect to the server and create the secret
        ssh root@${{ inputs.server_ip || '5.161.81.57' }} << 'EOF'
          # Wait for k3s to be ready
          until kubectl get nodes; do 
            echo "Waiting for k3s to be ready..."
            sleep 5
          done
          
          # Create namespace if it doesn't exist
          kubectl create namespace onepassword || true
          
          # Create or update the bootstrap secret
          kubectl create secret generic onepassword-connect-token \
            --from-literal=token='$CONNECT_TOKEN' \
            -n onepassword \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "‚úÖ 1Password Connect bootstrap secret created successfully"
        EOF

    - name: Verify secret creation
      run: |
        ssh root@${{ inputs.server_ip || '5.161.81.57' }} << 'EOF'
          echo "üîç Verifying secret creation..."
          kubectl get secret onepassword-connect-token -n onepassword -o jsonpath='{.metadata.name}' && echo " - Secret exists"
          kubectl get namespace onepassword -o jsonpath='{.metadata.name}' && echo " - Namespace exists"
          echo "‚úÖ Bootstrap verification complete"
        EOF
